global require modules 'cabinet' 'text' 'bool' 'vault' 'say'.

cabinet read file 'user_config.json' as json into ::config.

~ Register username and password into the vault.
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
vault lock 'user'   with secret ::config:content:user.
vault lock 'pwd'    with secret ::config:content:pass.
vault bind environment 'SYS_SECRET' with alias 'secret'.
vault bind environment 'MACHINE_ADMIN' with alias 'admin'.

~ Unlock (values are now tainted; taint propagates)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
vault unlock 'user'   into @user.
vault unlock 'pwd'    into @password.
vault unlock 'admin'  into @admin.
vault unlock 'secret' into @secret.

~ Validate credentials (no need to mark 'sensitive' here)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
sensitive text lower @user  into @user_lc.
sensitive text lower @admin into @admin_lc.
sensitive text compare @user_lc equal @admin_lc without case into @is_valid_user.
sensitive text compare @password equal @secret into @is_valid_password.

time now format 'YYYY-MM-DD HH:mm:ss' into @timestamp.

bool all @is_valid_user @is_valid_password into @ok.

if @ok
  ~ Egress: require 'with risk' because arguments are tainted
  sensitive say 'Login successful for @{user} at @{timestamp}.' with risk.

  ~ Backup config (no secret in path—no risk)
  cabinet copy file 'user_config.json' to 'backups/user_config_@{timestamp}.json'.

  ~ Log success (contains user → tainted) → with risk
  sensitive text concat 'SUCCESS: ' @timestamp ' User: ' @user into @log_entry.

  cabinet append file 'login.log' with @log_entry with risk elapsed timeout 5 seconds.

  success 'User authenticated and config backed up.'
else
  say 'Login failed for @{user} at @{timestamp}.' with risk.

  text concat 'FAILURE: ' @timestamp ' User: ' @user into @log_entry.
  cabinet append file 'login.log' with @log_entry with risk.

  http post 'https://notify.example.com'
    with { 'user': @user, 'status': 'failed', 'time': @timestamp } 
    with risk
    into @notify_result.

  failure 'Authentication failed.'
end